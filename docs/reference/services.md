# üîß Services Reference

## –û–±–∑–æ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤

–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π –≤—ã–¥–µ–ª–µ–Ω –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–Ω–µ–µ –Ω–∞—Ö–æ–¥–∏–ª–∞—Å—å –≤ ViewSets –∏ Serializers.

## HashtagService

**–§–∞–π–ª:** `books/services/hashtag_service.py`

–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ö—ç—à—Ç–µ–≥–∞–º–∏ –∫–Ω–∏–≥.

### –ú–µ—Ç–æ–¥—ã

#### `normalize_name(name: str) -> str`
–ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —Ö—ç—à—Ç–µ–≥–∞:
- –£–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
- –£–±–∏—Ä–∞–µ—Ç `#` –≤ –Ω–∞—á–∞–ª–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ

**–ü—Ä–∏–º–µ—Ä:**
```python
HashtagService.normalize_name("  #—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞  ")  # ‚Üí "—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞"
HashtagService.normalize_name("—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞")  # ‚Üí "—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞"
```

#### `create_slug(name: str) -> str`
–°–æ–∑–¥–∞–µ—Ç slug –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —Ö—ç—à—Ç–µ–≥–∞ –¥–ª—è URL.

#### `get_or_create_hashtag(name: str, creator: User) -> tuple[Hashtag, bool]`
–°–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç —Ö—ç—à—Ç–µ–≥. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `(hashtag, created)`.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `name` ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Ö—ç—à—Ç–µ–≥–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å `#` –∏–ª–∏ –±–µ–∑)
- `creator` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-—Å–æ–∑–¥–∞—Ç–µ–ª—å

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `(Hashtag, bool)` ‚Äî —Ö—ç—à—Ç–µ–≥ –∏ —Ñ–ª–∞–≥ —Å–æ–∑–¥–∞–Ω–∏—è

#### `add_hashtags_to_book(book: Book, hashtag_names: List[str], creator: User) -> List[Hashtag]`
–î–æ–±–∞–≤–ª—è–µ—Ç —Ö—ç—à—Ç–µ–≥–∏ –∫ –∫–Ω–∏–≥–µ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –ª–∏–º–∏—Ç–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `book` ‚Äî –∫–Ω–∏–≥–∞
- `hashtag_names` ‚Äî —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π —Ö—ç—à—Ç–µ–≥–æ–≤
- `creator` ‚Äî —Å–æ–∑–¥–∞—Ç–µ–ª—å —Ö—ç—à—Ç–µ–≥–æ–≤

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- –°–ø–∏—Å–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ö—ç—à—Ç–µ–≥–æ–≤

**–ò—Å–∫–ª—é—á–µ–Ω–∏—è:**
- `HashtagLimitExceeded` ‚Äî –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç (20 —Ö—ç—à—Ç–µ–≥–æ–≤ –Ω–∞ –∫–Ω–∏–≥—É)

---

## TransferService

**–§–∞–π–ª:** `books/services/transfer_service.py`

–°–µ—Ä–≤–∏—Å –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∫–Ω–∏–≥ –º–µ–∂–¥—É –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.

### –ú–µ—Ç–æ–¥—ã

#### `transfer_to_library(book: Book, library: Library) -> Book`
–ü–µ—Ä–µ–¥–∞–µ—Ç –∫–Ω–∏–≥—É –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É (–º–µ–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ `library`, `owner` –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º).

#### `transfer_to_user(book: Book, new_owner: User) -> Book`
–ü–µ—Ä–µ–¥–∞–µ—Ç –∫–Ω–∏–≥—É –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–º–µ–Ω—è–µ—Ç `owner`).

#### `transfer_book(book: Book, library_id: int = None, user_id: int = None) -> tuple[Book, str]`
–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –ø–µ—Ä–µ–¥–∞—á–∏ –∫–Ω–∏–≥–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `book` ‚Äî –∫–Ω–∏–≥–∞ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏
- `library_id` ‚Äî ID –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `user_id` ‚Äî ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `(Book, str)` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∫–Ω–∏–≥–∞ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ

**–ò—Å–∫–ª—é—á–µ–Ω–∏—è:**
- `TransferError` ‚Äî –µ—Å–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∏–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω –Ω–∏ –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä

---

## BookService

**–§–∞–π–ª:** `books/services/book_service.py`

–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–Ω–∏–≥–∞–º–∏ –∏ –∏—Ö —Å–≤—è–∑—è–º–∏.

### –ú–µ—Ç–æ–¥—ã

#### `create_book_with_relations(validated_data: dict, author_ids: List[int], hashtag_names: Optional[List[str]], creator: User) -> Book`
–°–æ–∑–¥–∞–µ—Ç –∫–Ω–∏–≥—É —Å–æ –≤—Å–µ–º–∏ —Å–≤—è–∑—è–º–∏ (–∞–≤—Ç–æ—Ä—ã, —Ö—ç—à—Ç–µ–≥–∏).

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `validated_data` ‚Äî –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏
- `author_ids` ‚Äî —Å–ø–∏—Å–æ–∫ ID –∞–≤—Ç–æ—Ä–æ–≤ (–¥–æ 3-—Ö)
- `hashtag_names` ‚Äî —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π —Ö—ç—à—Ç–µ–≥–æ–≤ (–¥–æ 20, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `creator` ‚Äî —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–Ω–∏–≥–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–∞–∫ `owner`)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- –°–æ–∑–¥–∞–Ω–Ω—É—é –∫–Ω–∏–≥—É —Å–æ –≤—Å–µ–º–∏ —Å–≤—è–∑—è–º–∏

#### `update_book_authors(book: Book, author_ids: Optional[List[int]]) -> None`
–û–±–Ω–æ–≤–ª—è–µ—Ç –∞–≤—Ç–æ—Ä–æ–≤ –∫–Ω–∏–≥–∏ (—É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å–≤—è–∑–∏, —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ).

---

## document_processor

**–§–∞–π–ª:** `books/services/document_processor.py`

–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –∫–æ—Ä—Ä–µ–∫—Ü–∏–µ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã.

### –§—É–Ω–∫—Ü–∏–∏

#### `process_document(input_path, output_path) -> tuple[int, int]`
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç: –Ω–∞—Ö–æ–¥–∏—Ç –≥—Ä–∞–Ω–∏—Ü—ã, –ø—Ä–∏–º–µ–Ω—è–µ—Ç –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `input_path` ‚Äî –ø—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
- `output_path` ‚Äî –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `(width, height)` ‚Äî —Ä–∞–∑–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–ò—Å–∫–ª—é—á–µ–Ω–∏—è:**
- `ValueError` ‚Äî –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –Ω–∞–π—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

### –í ViewSets

```python
from .services.hashtag_service import HashtagService
from .services.transfer_service import TransferService

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ö—ç—à—Ç–µ–≥–æ–≤
added_hashtags = HashtagService.add_hashtags_to_book(
    book, hashtag_names, request.user
)

# –ü–µ—Ä–µ–¥–∞—á–∞ –∫–Ω–∏–≥–∏
book, message = TransferService.transfer_book(
    book, library_id=library_id, user_id=user_id
)
```

### –í Serializers

```python
from .services.book_service import BookService

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ —Å–æ —Å–≤—è–∑—è–º–∏
book = BookService.create_book_with_relations(
    validated_data, author_ids, hashtag_names, creator
)
```

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-11-03

