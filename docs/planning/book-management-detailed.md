# Детальный план реализации функционала работы с книгами

**Дата создания:** 2025-01-27  
**Статус:** Детализированный план реализации  
**Основа:** Утвержденный план из `book-management.md`

---

## Технологический стек

### Нормализация изображений
- **Технология:** OpenCV (бесплатная альтернатива, без платных SDK)
- **Механизм:** 
  - Обнаружение границ документа через несколько методов (Canny, Sobel, Laplacian, адаптивная бинаризация)
  - Перспективное преобразование (four_point_transform)
  - Сохранение с качеством JPEG 90%
  - Fallback для белых документов на белом фоне (использование границ изображения)
- **Использование:** Реализован `normalize_pages_batch()` для пакетной обработки

### LLM интеграция
- **API:** OpenAI GPT-4o (ChatGPT-4o)
- **Модель:** `gpt-4o`
- **Формат ответа:** Строго структурированный JSON
- **Входные данные:** 
  - Изображения страниц (base64 или URLs)
  - JSON с категориями из `categories_canonical.json`

---

## Структура JSON для LLM

### Входные данные (категории)
```json
{
  "categories": [
    {
      "id": 1,
      "name": "Азия",
      "subcategories": [
        {"id": 2, "name": "Индия, Пакистан, Тибет, Цейлон (Шри-Ланка)"},
        ...
      ]
    },
    ...
  ]
}
```

### Выходные данные от LLM (структурированный JSON)
```json
{
  "title": "Название книги",
  "subtitle": "Подзаголовок (если есть)",
  "category_id": 1,
  "authors": ["Фамилия Имя", "Фамилия Имя"],
  "publisher_name": "Название издательства",
  "publication_place": "Город",
  "year": 2023,
  "year_approx": "",
  "pages_info": "300 стр., ил.",
  "circulation": 5000,
  "language_name": "Русский",
  "binding_type": "hard",
  "binding_details": "Твердый переплет, красный",
  "format": "regular",
  "condition": "excellent",
  "condition_details": "",
  "price_rub": "1500.00",
  "seller_code": "",
  "isbn": "978-5-123456-78-9",
  "description": "Аннотация книги"
}
```

**Поля, НЕ включаемые в ответ LLM:**
- `owner` - заполняется автоматически на бэкенде
- `library` - выбирается пользователем в форме
- `status` - выбирается пользователем в форме (none, reading, read, want_to_read, want_to_reread)
- `hashtags` - добавляются пользователем в форме
- `reading_dates` - добавляются пользователем в форме для книг со статусом 'read' и 'want_to_reread' (можно добавить несколько дат для отслеживания перечитываний)
- `created_at`, `updated_at` - системные поля
- `electronic_versions`, `pages`, `reviews` - управляются отдельно

**ВАЖНО:** Страницы книги (`pages`) - это и есть изображения книги. Отдельной модели `BookImage` не требуется. Все изображения хранятся как страницы книги (`BookPage`).

---

## Промпт для LLM

```markdown
Ты - эксперт по анализу книг. Проанализируй предоставленные изображения страниц книги и извлеки всю возможную информацию.

ДОСТУПНЫЕ КАТЕГОРИИ:
{categories_json}

ЗАДАЧА:
1. Определи название книги
2. Определи авторов (если есть)
3. Определи издательство
4. Определи место и год издания
5. Определи ISBN (если есть)
6. Определи тип переплета, формат, состояние
7. Определи язык текста
8. Определи наиболее подходящую категорию из предоставленного списка
9. Извлеки любую другую доступную информацию

ВАЖНО:
- Если информация не найдена на изображениях, оставь поле пустым или null
- Для category_id используй ID из предоставленного списка категорий
- Для binding_type используй только: paper, selfmade, cardboard, hard, fabric, owner, halfleather, composite, leather
- Для format используй только: very_large, encyclopedic, increased, regular, reduced, miniature
- Для condition используй только: ideal, excellent, good, satisfactory, poor
- Для language_name используй полное название языка (например, "Русский", "Английский")
- Авторов может не быть (массив может быть пустым)
- Год издания может быть точным (year) или приблизительным (year_approx, например "197?", "18??")

ВЕРНИ ОТВЕТ СТРОГО В ФОРМАТЕ JSON согласно схеме:
{
  "title": string (обязательно),
  "subtitle": string или null,
  "category_id": integer или null,
  "authors": array of strings или [],
  "publisher_name": string или null,
  "publication_place": string или null,
  "year": integer или null,
  "year_approx": string или null,
  "pages_info": string или null,
  "circulation": integer или null,
  "language_name": string или null,
  "binding_type": string или null,
  "binding_details": string или null,
  "format": string или null,
  "condition": string или null,
  "condition_details": string или null,
  "price_rub": string или null (десятичное число как строка),
  "seller_code": string или null,
  "isbn": string или null,
  "description": string или null
}
```

---

## Этапы реализации

### Этап 1: BookDetailModal (Просмотр книги) ✅ ЗАВЕРШЕН

**Цель:** Реализовать модальное окно для просмотра детальной информации о книге

#### Задачи:
1. ✅ Создать компонент `BookDetailModal.js`
2. ✅ Создать стили `BookDetailModal.css`
3. ✅ Интегрировать с главной страницей (открытие по клику на карточку)
4. ✅ Реализовать отображение всех полей книги
5. ✅ Реализовать отображение страниц книги:
   - Главная картинка слева вверху (крупно, почти на всю ширину)
   - Миниатюры всех страниц справа (вертикальный список)
   - При клике на миниатюру - замена главной картинки
6. ✅ Добавить кнопки действий: "Редактировать", "Передать", "Удалить", "Закрыть"
7. ✅ Улучшить UI: заголовок с названием книги, разделительные полоски
8. ✅ Реализовать систему обложек (cover_page) для книг
9. ✅ Отобразить электронные версии книг: значки форматов как ссылки на скачивание (внизу модального окна)
10. ✅ Реализовать отображение отзывов на книгу:
    - Отображение списка всех отзывов с информацией: когда, кто, текст, звезды (1-5)
    - Средний рейтинг книги (вычисляется на бэкенде)
    - Пользователь может редактировать/удалить свой отзыв (с подтверждением через ConfirmModal)
    - Отзыв может содержать только текст, только звезды, или и то и другое
    - Блок отзывов размещается внизу, ниже электронных версий
11. ✅ Реализовать отображение среднего рейтинга в списке книг:
    - Добавить average_rating в BookListSerializer (для списка книг)
    - Графическое отображение среднего рейтинга звездами в BookCard (1-5 звезд)
    - Отображать средний рейтинг только если есть отзывы с оценками
12. ✅ Создать компонент ConfirmModal для замены системных окон (alert/confirm)
13. ✅ Удалить все системные окна (alert/confirm) из BookDetailModal и заменить на ConfirmModal
14. ✅ Добавить отображение даты прочтения для прочитанных книг (первая дата прочтения отображается рядом со статусом)
15. ✅ Обновить фабрику для генерации дат прочтения для книг со статусом 'read' и 'want_to_reread'
16. ✅ Добавить отображение даты прочтения также для книг со статусом 'want_to_reread' (логично, так как книга уже была прочитана)

#### API Endpoints:
- `GET /api/books/{id}/` - получение детальной информации (включает reviews и average_rating)
- `POST /api/reviews/` - создание/обновление отзыва (upsert)
- `PUT /api/reviews/{id}/` - обновление отзыва
- `DELETE /api/reviews/{id}/` - удаление отзыва

#### Структура данных:
```javascript
{
  id, title, subtitle, category, authors, publisher, publication_place,
  year, year_approx, pages_info, circulation, language, binding_type,
  binding_details, format, condition, condition_details, price_rub,
  seller_code, isbn, description, status, library, owner, created_at,
  electronic_versions: [], pages: [], reviews: [
    {
      id, user, user_username, rating (1-5 или null), 
      review_text (или пусто), created_at, updated_at
    }
  ], 
  average_rating: 0-5 или null (средний рейтинг всех отзывов с звездами, null если нет отзывов с оценками),
  reading_dates: [], hashtags: []
}
```

**Примечание:** `pages` - это массив страниц книги (BookPage), которые являются изображениями книги. Отдельной модели `BookImage` не требуется - страницы и изображения это одно и то же.

#### Тестирование:
- [x] Модальное окно открывается по клику на карточку книги
- [x] Все поля отображаются корректно
- [x] Пустые поля обрабатываются правильно (не показываются или показывается "Не указано")
- [x] Отображение страниц работает корректно:
  - [x] Главная картинка отображается слева вверху
  - [x] Миниатюры всех страниц отображаются справа
  - [x] При клике на миниатюру главная картинка заменяется
  - [x] Если страниц нет - секция не отображается
- [x] Кнопки действий отображаются
- [x] Кнопка "Закрыть" закрывает модальное окно
- [x] Модальное окно закрывается по клику вне его области
- [x] Модальное окно закрывается по нажатию Escape
- [x] Отображение страниц (изображений) работает корректно
- [x] Отображение списка авторов работает корректно
- [x] Отображение хэштегов работает корректно
- [x] Заголовок модального окна показывает название книги
- [x] Разделительные полоски между секциями работают корректно
- [x] Обложки книг (cover_page) отображаются в карточках списка
- [x] Электронные версии книг отображаются с иконками форматов и ссылками на скачивание
- [x] Отзывы отображаются в виде списка с информацией о пользователе и дате
- [x] Средний рейтинг книги отображается корректно
- [x] Звезды рейтинга отображаются визуально (1-5 звезд)
- [x] Пользователь видит кнопки редактирования/удаления для своего отзыва
- [x] Пользователь может редактировать свой отзыв (текст и/или звезды)
- [x] Пользователь может удалить свой отзыв (с подтверждением через ConfirmModal, не через window.confirm)
- [x] Отзывы без текста отображаются корректно (только звезды)
- [x] Отзывы без звезд отображаются корректно (только текст)
- [x] Блок отзывов размещен ниже электронных версий
- [x] Средний рейтинг отображается в списке книг (BookCard) графически (звездами)
- [x] Средний рейтинг в списке обновляется после изменения отзывов
- [x] Если у книги нет отзывов с оценками, рейтинг не отображается
- [x] Ошибки при сохранении/удалении отзывов показываются через ConfirmModal (не через alert)
- [x] Удален дублирующийся блок с количеством отзывов из секции "Связанные данные"
- [x] Для прочитанных книг (status='read' или 'want_to_reread') отображается дата первого прочтения рядом со статусом
- [x] Фабрика генерирует даты прочтения (от 1 до 5) для книг со статусом 'read' и 'want_to_reread'

---

### Этап 2: BookCreateWizard - Шаг 1 (Загрузка страниц)

**Цель:** Реализовать загрузку страниц книги (страницы = изображения книги)

**ВАЖНО:** Страницы книги и изображения - это одно и то же. Отдельного функционала для добавления "изображений" не требуется.

#### Задачи:
1. Создать компонент `BookCreateWizard.js` с управлением шагами
2. Создать компонент `UploadPagesStep.js`
3. Создать стили для wizard и шага загрузки
4. Реализовать drag-and-drop зону
5. Реализовать выбор файлов через input
6. Реализовать отображение списка загруженных файлов
7. Реализовать удаление файлов из списка
8. Добавить кнопки "Пропустить" и "Далее"
9. Валидация: только изображения (jpeg, jpg, png, webp)

#### Технические детали:
- Использовать `FileReader` для предпросмотра
- Хранить файлы в состоянии React (File objects)
- Максимальный размер файла: 10MB (настраиваемо)
- Максимальное количество файлов: 50 (настраиваемо)

#### Тестирование:
- [ ] Drag-and-drop работает корректно
- [ ] Выбор файлов через кнопку работает
- [ ] Валидация типов файлов работает (только изображения)
- [ ] Валидация размера файлов работает
- [ ] Валидация количества файлов работает
- [ ] Предпросмотр загруженных изображений работает
- [ ] Удаление файлов из списка работает
- [ ] Кнопка "Пропустить" переходит к шагу 4
- [ ] Кнопка "Далее" переходит к шагу 2 (если есть файлы) или шагу 4 (если нет)
- [ ] Сообщения об ошибках валидации отображаются корректно (через ConfirmModal, не через alert)

---

### Этап 3: BookCreateWizard - Шаг 2 (Нормализация страниц)

**Статус:** ⚠️ ТРЕБУЕТ ДОРАБОТКИ

**Примечание:** Базовая функциональность реализована, но качество нормализации требует улучшения. Необходимо вернуться к этому этапу позже для доработки алгоритма обнаружения границ документа и улучшения результатов нормализации.

**Цель:** Реализовать автоматическую нормализацию загруженных страниц

#### Задачи:
1. Создать компонент `NormalizationStep.js`
2. Создать API endpoint `POST /api/books/normalize-pages/`
3. Адаптировать `process_document()` для пакетной обработки
4. Реализовать прогресс-бар нормализации
5. Реализовать отображение миниатюр до и после нормализации
6. Добавить кнопки "Пропустить нормализацию" и "Далее"
7. Сохранение нормализованных изображений во временное хранилище

#### API Endpoint:
```python
POST /api/books/normalize-pages/
Content-Type: multipart/form-data

Body:
- files: List[File] - загруженные изображения

Response:
{
  "normalized_images": [
    {
      "id": "temp_123",
      "original_filename": "page1.jpg",
      "normalized_url": "/media/temp/normalized_123.jpg",
      "width": 1920,
      "height": 2560
    },
    ...
  ],
  "total": 5,
  "processed": 5
}
```

#### Технические детали:
- Использовать существующий `document_processor.process_document()`
- Обработка файлов последовательно или параллельно (на выбор)
- Сохранение во временную директорию `media/temp/normalized/`
- Очистка временных файлов через 24 часа (cron job или celery task)

#### Тестирование:
- [x] Нормализация работает для одного файла
- [x] Нормализация работает для нескольких файлов
- [x] Прогресс-бар обновляется корректно
- [x] Миниатюры до и после отображаются корректно
- [x] Ошибки обработки обрабатываются корректно (через ConfirmModal, не через alert)
- [x] Кнопка "Пропустить нормализацию" работает
- [x] Кнопка "Далее" активна после завершения нормализации
- [x] Временные файлы создаются корректно
- [x] Нормализованные изображения имеют правильные размеры
- [x] Нормализация работает для контрастных изображений (яркие цвета на белом фоне)
- [x] Нормализация работает для белых документов на белом фоне (через fallback)

---

### Этап 4: BookCreateWizard - Шаг 3 (Автозаполнение через LLM) ✅ ЗАВЕРШЕН

**Цель:** Реализовать автоматическое заполнение данных книги через OpenAI GPT-4o

#### Задачи:
1. ✅ Создать компонент `AutoFillStep.js`
2. ✅ Создать сервис `llm_service.py` для работы с OpenAI API
3. ✅ Создать API endpoint `POST /api/books/auto-fill/`
4. ✅ Реализовать загрузку категорий из базы данных (Category model)
5. ✅ Реализовать отправку изображений и категорий в OpenAI API
6. ✅ Реализовать парсинг ответа от LLM
7. ✅ Реализовать валидацию ответа от LLM
8. ✅ Реализовать автоматический переход к следующему шагу после успешного автозаполнения
9. ✅ Добавить кнопки "Заполнить автоматически" и "Пропустить автозаполнение"
10. ✅ Реализовать обработку ошибок региональных ограничений OpenAI API (403 Forbidden)
11. ✅ Увеличить max_tokens до 8000 для полного описания книги
12. ✅ Реализовать двухэтапный подход к выбору категории (анализ → выбор из списка)

#### API Endpoint:
```python
POST /api/books/auto-fill/
Content-Type: application/json

Body:
{
  "normalized_image_ids": ["temp_123", "temp_124", ...],
  "normalized_image_urls": ["/media/temp/normalized_123.jpg", ...]
}

Response:
{
  "success": true,
  "data": {
    "title": "...",
    "subtitle": "...",
    ...
  },
  "confidence": 0.85  // Уровень уверенности LLM (опционально)
}
```

#### Сервис LLM (`llm_service.py`):
```python
def auto_fill_book_data(image_urls, categories_json):
    """
    Отправляет изображения и категории в OpenAI GPT-4o
    и получает структурированные данные о книге
    """
    # 1. Подготовка промпта
    # 2. Отправка запроса в OpenAI API
    # 3. Парсинг ответа
    # 4. Валидация данных
    # 5. Возврат структурированных данных
```

#### Технические детали:
- Использовать `openai` Python библиотеку
- Модель: `gpt-4o`
- Формат ответа: JSON mode (если доступно) или strict JSON parsing
- Таймаут запроса: 60 секунд
- Обработка ошибок: retry с exponential backoff (до 3 попыток)
- Логирование всех запросов и ответов

#### Тестирование:
- [x] Отправка изображений в OpenAI API работает
- [x] Промпт формируется корректно
- [x] Категории передаются корректно (из базы данных с ID)
- [x] Ответ от LLM парсится корректно
- [x] Валидация ответа от LLM работает
- [x] Обработка ошибок API работает (network, timeout, rate limit, региональные ограничения) - ошибки показываются через ConfirmModal
- [x] Retry механизм работает (exponential backoff, до 3 попыток)
- [x] Автоматический переход к следующему шагу после успешного автозаполнения работает
- [x] Кнопка "Пропустить автозаполнение" работает
- [x] Если страницы не загружены, шаг 3 пропускается автоматически
- [x] Индикатор загрузки отображается корректно
- [x] Полное описание книги извлекается (max_tokens=8000)
- [x] Категория определяется корректно (двухэтапный подход)

---

### Этап 5: BookCreateWizard - Шаг 4 (Заполнение данных) ✅ ЗАВЕРШЕН (частично)

**Цель:** Реализовать форму для заполнения/редактирования данных книги

#### Задачи:
1. ✅ Создать компонент `BookFormStep.js` с полной формой
2. ✅ Реализовать все основные поля формы с соответствующими типами input
3. ✅ Реализовать автоподбор авторов (`GET /api/authors/?search=...`) с debounce
4. ✅ Реализовать автоподбор издательств (`GET /api/publishers/?search=...`) с debounce
5. ✅ Реализовать создание новых авторов (inline модальное окно `CreateAuthorModal`)
6. ✅ Реализовать создание новых издательств (inline модальное окно `CreatePublisherModal`)
7. ✅ Реализовать выбор категории из дерева категорий (select dropdown)
8. ✅ Реализовать выбор языка из списка языков (text input с автозаполнением)
9. ⏳ Реализовать выбор библиотеки из библиотек пользователя (будет на этапе 6)
10. ⏳ Реализовать выбор хэштегов (с созданием новых) (будет на этапе 6)
11. ⏳ Реализовать загрузку электронных версий книги (будет на этапе 6)
12. ⏳ Реализовать выбор статуса книги (будет на этапе 6)
13. ⏳ Реализовать добавление дат прочтения (будет на этапе 6)
14. ✅ Реализовать валидацию формы (только title обязателен)
15. ✅ Добавить кнопки "Назад" и "Далее"
16. ✅ Реализовать автоматический поиск авторов и издательств после автозаполнения LLM
17. ✅ Реализовать отображение временных авторов (не найденных в БД) с возможностью создания
18. ✅ Реализовать отображение ссылки на сайт издательства после выбора
19. ✅ Исправить проблему с вложенными формами (заменены на div)

#### Компоненты:
- ✅ `BookFormStep.js` - основная форма
- ✅ `AuthorAutocomplete.js` - автоподбор авторов (с поддержкой множественных авторов, временных авторов, чипсов)
- ✅ `PublisherAutocomplete.js` - автоподбор издательств (с отображением сайта)
- ✅ `CategorySelector.js` - выбор категории (реализован через select в BookFormStep)
- ✅ `LanguageSelector.js` - выбор языка (реализован через text input в BookFormStep)
- ⏳ `LibrarySelector.js` - выбор библиотеки (будет на этапе 6)
- ⏳ `HashtagSelector.js` - выбор хэштегов (будет на этапе 6)
- ✅ `CreateAuthorModal.js` - создание нового автора
- ✅ `CreatePublisherModal.js` - создание нового издательства
- ⏳ `ElectronicVersionsUpload.js` - загрузка электронных версий книги (будет на этапе 6)

#### Валидация:
- Название (title): обязательное, минимум 1 символ, максимум 500 символов
- Год издания (year): если указан, должен быть от 0 до 2100
- Тираж (circulation): если указан, должен быть >= 1
- Цена (price_rub): если указана, должна быть >= 0
- Авторы: максимум 3 автора
- Хэштеги: максимум 20 хэштегов
- Электронные версии: поддерживаемые форматы (PDF, EPUB, MOBI, FB2, DJVU, TXT, RTF, DOC, DOCX)
- Размер файла электронной версии: максимум 100MB (настраиваемо)

#### Тестирование:
- [x] Все основные поля формы отображаются корректно
- [x] Предзаполнение данными от LLM работает
- [x] Автоподбор авторов работает (debounce 300ms)
- [x] Автоподбор издательств работает (debounce 300ms)
- [x] Создание нового автора работает (с заменой временного на созданного)
- [x] Создание нового издательства работает
- [x] Выбор категории работает (select dropdown с иерархией)
- [x] Выбор языка работает (text input)
- [ ] Выбор библиотеки работает (будет на этапе 6)
- [ ] Выбор хэштегов работает (будет на этапе 6)
- [ ] Выбор статуса книги работает (будет на этапе 6)
- [ ] Добавление дат прочтения работает (будет на этапе 6)
- [ ] Загрузка электронных версий работает (будет на этапе 6)
- [ ] Валидация форматов электронных версий работает (будет на этапе 6)
- [ ] Валидация размера файлов электронных версий работает (будет на этапе 6)
- [ ] Удаление загруженных электронных версий работает (будет на этапе 6)
- [x] Валидация названия работает (обязательное поле)
- [x] Валидация других полей работает (если заполнены)
- [x] Кнопка "Назад" работает (переход к предыдущему шагу)
- [x] Кнопка "Далее" активна только если заполнено название
- [x] Сообщения об ошибках валидации отображаются корректно (через ConfirmModal, не через alert)
- [x] Можно создать книгу только с названием (без других полей)
- [x] Автоматический поиск авторов после автозаполнения LLM работает
- [x] Автоматический поиск издательств после автозаполнения LLM работает
- [x] Временные авторы (не найденные в БД) отображаются с желтым фоном и кнопкой создания
- [x] После создания автора временный автор заменяется на созданного
- [x] Ссылка на сайт издательства отображается после выбора

---

### Этап 6: BookCreateWizard - Шаг 5 (Подтверждение и создание) ✅ ЗАВЕРШЕН

**Цель:** Реализовать финальный просмотр и создание книги

#### Задачи:
1. ✅ Создать компонент `ConfirmationStep.js`
2. ✅ Реализовать отображение сводки всех данных книги
3. ✅ Реализовать отображение миниатюр страниц (если были загружены)
4. ⏳ Реализовать отображение списка загруженных электронных версий (будет на следующих этапах)
5. ✅ Реализовать валидацию перед созданием (проверка названия)
6. ✅ Реализовать отправку запроса на создание книги (включая нормализованные страницы)
7. ✅ Реализовать обработку успеха/ошибок
8. ✅ Добавить кнопки "Назад", "Создать книгу", "Отмена"
9. ✅ Реализовать автоматическое назначение библиотеки (первая библиотека пользователя, если не указана)
10. ✅ Реализовать обработку нормализованных страниц: перемещение из temp в постоянное хранилище и создание BookPage записей
11. ✅ Добавить поддержку `language_name` в сериализаторе (автоматическое создание языка, если не найден)

#### API Endpoint:
```python
POST /api/books/
Content-Type: multipart/form-data или application/json

Body:
{
  // Все поля книги + normalized_image_ids + electronic_versions (files)
}
```

#### Технические детали:
- ✅ При создании книги переместить нормализованные изображения из `media/temp/normalized/` в `media/books/pages/processed/`
- ✅ Создать записи BookPage для каждой нормализованной страницы с метаданными (width, height, processing_status='completed')
- ⏳ Сохранить загруженные файлы электронных версий в `media/books/electronic/` (будет на следующих этапах)
- ⏳ Создать записи BookElectronic для каждой загруженной электронной версии (будет на следующих этапах)
- ✅ Обработать создание авторов/издательств (уже реализовано на этапе 5)
- ✅ После успешного создания закрыть wizard и обновить список книг
- ✅ Автоматическое назначение библиотеки (первая библиотека пользователя, если не указана)
- ✅ Обработка `language_name`: автоматическое создание языка, если не найден в базе

#### Тестирование:
- [x] Сводка всех данных отображается корректно
- [x] Миниатюры страниц отображаются (если были загружены)
- [ ] Список электронных версий отображается (будет на следующих этапах)
- [x] Валидация названия перед созданием работает
- [x] Создание книги работает (все поля)
- [x] Создание книги работает (только название)
- [x] Создание книги с авторами работает
- [x] Создание книги с нормализованными страницами работает (файлы перемещаются, создаются BookPage записи)
- [ ] Создание книги с электронными версиями работает (будет на следующих этапах)
- [x] Обработка ошибок создания работает (через ConfirmModal)
- [x] После успешного создания wizard закрывается
- [x] После успешного создания список книг обновляется
- [x] Кнопка "Назад" работает
- [x] Кнопка "Отмена" закрывает wizard (с подтверждением через ConfirmModal, если есть незавершенные изменения)
- [x] Все ошибки валидации и сохранения показываются через ConfirmModal (не через alert)
- [x] Автоматическое назначение библиотеки работает
- [x] Нормализованные страницы сохраняются и отображаются в BookDetailModal

---

### Этап 7: BookEditModal (Редактирование книги)

**Цель:** Реализовать модальное окно для редактирования существующей книги

#### Задачи:
1. ✅ Создать компонент `BookEditModal.js`
2. ✅ Переиспользовать форму из `BookFormStep.js` (или создать общий компонент)
3. ✅ Реализовать загрузку данных книги при открытии
4. ✅ Реализовать предзаполнение формы существующими данными
5. ✅ Реализовать управление электронными версиями (добавление/удаление)
6. ✅ Реализовать управление страницами (просмотр/добавление/удаление) - страницы = изображения книги
7. ✅ Реализовать управление статусом книги и датами прочтения (изменение статуса, добавление/удаление дат прочтения для статусов 'read' и 'want_to_reread')
8. ✅ Реализовать сохранение изменений
9. ✅ Добавить кнопки "Сохранить изменения" и "Отмена"
10. ✅ Исправить проблему с автоматическим показом списка автодополнения в PublisherAutocomplete
11. Примечание: отзывы на книгу редактируются отдельно через BookDetailModal (не через BookEditModal)

**ВАЖНО:** Страницы книги (`pages`) - это и есть изображения книги. Отдельного функционала для управления "изображениями" не требуется. Модель `BookImage` существует в коде, но не используется и не должна использоваться. Все изображения управляются через страницы (`BookPage`).

#### API Endpoints:
- `GET /api/books/{id}/` - получение данных для редактирования
- `PUT /api/books/{id}/` - обновление книги
- `POST /api/books/{id}/upload_pages/` - добавление страниц (страницы = изображения)
- `DELETE /api/books/{id}/pages/{page_id}/` - удаление страницы
- `POST /api/books/{id}/electronic_versions/` - добавление электронной версии
- `DELETE /api/books/{id}/electronic_versions/{version_id}/` - удаление версии
- `POST /api/books/{id}/reading_dates/` - добавление даты прочтения
- `DELETE /api/books/{id}/reading_dates/{date_id}/` - удаление даты прочтения
- Примечание: отзывы управляются через `/api/reviews/` (не через BookEditModal)

**ВАЖНО:** Endpoints `/api/books/{id}/images/` существуют в коде, но не должны использоваться. Все изображения управляются через страницы (`/api/books/{id}/pages/`).

#### Тестирование:
- [x] Модальное окно открывается из BookDetailModal
- [x] Данные книги загружаются корректно
- [x] Форма предзаполняется существующими данными
- [x] Редактирование всех полей работает
- [x] Валидация работает
- [x] Сохранение изменений работает
- [x] Добавление электронных версий работает
- [x] Удаление электронных версий работает (с подтверждением через ConfirmModal)
- [x] Добавление страниц (изображений) работает
- [x] Удаление страниц (изображений) работает (с подтверждением через ConfirmModal)
- [x] Изменение статуса книги работает
- [x] Добавление/удаление дат прочтения работает (для книг со статусом 'read' и 'want_to_reread')
- [x] После сохранения данные в BookDetailModal обновляются
- [x] Кнопка "Отмена" закрывает модальное окно
- [x] Обработка ошибок сохранения работает (через ConfirmModal, не через alert)
- [x] Исправлена проблема с автоматическим показом списка автодополнения при открытии формы

**ВАЖНО:** Отдельного функционала для добавления "изображений" не требуется - страницы и изображения это одно и то же. Все изображения управляются через страницы.

---

### Этап 8: BookTransferModal (Передача книги)

**Цель:** Реализовать модальное окно для передачи книги в другую библиотеку

#### Задачи:
1. ✅ Создать компонент `BookTransferModal.js`
2. ✅ Реализовать загрузку списка доступных библиотек
3. ✅ Реализовать выбор целевой библиотеки
4. ✅ Реализовать отправку запроса на передачу
5. ✅ Добавить кнопки "Передать" и "Отмена"

#### API Endpoint:
```python
POST /api/books/{id}/transfer/
Content-Type: application/json

Body:
{
  "target_library_id": 5
}

Response:
{
  "success": true,
  "message": "Книга успешно передана",
  "book": {...}
}
```

#### Тестирование:
- [x] Модальное окно открывается из BookDetailModal
- [x] Список доступных библиотек загружается
- [x] Выбор библиотеки работает
- [x] Передача книги работает
- [x] После передачи данные в BookDetailModal обновляются
- [x] Кнопка "Отмена" закрывает модальное окно
- [x] Обработка ошибок передачи работает (через ConfirmModal, не через alert)

---

### Этап 9: BookDeleteConfirm (Подтверждение удаления)

**Цель:** Реализовать диалог подтверждения удаления книги

#### Задачи:
1. ✅ Использовать компонент `ConfirmModal` (уже создан) вместо создания отдельного компонента
2. ✅ Реализовать отображение информации о книге в сообщении подтверждения
3. ✅ Реализовать отправку запроса на удаление
4. ✅ Кнопки "Удалить" и "Отмена" уже реализованы в ConfirmModal

#### API Endpoint:
```python
DELETE /api/books/{id}/
```

#### Тестирование:
- [x] Диалог открывается из BookDetailModal (используется ConfirmModal)
- [x] Информация о книге отображается корректно
- [x] Удаление книги работает (с подтверждением через ConfirmModal)
- [x] После удаления все модальные окна закрываются
- [x] После удаления список книг обновляется
- [x] Кнопка "Отмена" закрывает диалог
- [x] Обработка ошибок удаления работает (через ConfirmModal, не через alert)

---

## Общие требования ко всем этапам

### UI/UX
- Все модальные окна должны быть responsive
- Анимации открытия/закрытия модальных окон
- Индикаторы загрузки для всех асинхронных операций
- Сообщения об ошибках должны быть понятными
- **КРИТИЧЕСКИ ВАЖНО: Запрещено использование системных окон (`alert()`, `confirm()`, `prompt()`). Все подтверждения, уведомления и ошибки должны отображаться через собственные модальные окна (`ConfirmModal`).**
- Успешные операции должны показывать уведомления

### Обработка ошибок
- Сетевые ошибки (network, timeout)
- Ошибки валидации (400)
- Ошибки авторизации (401, 403)
- Ошибки сервера (500)
- Специфичные ошибки API

### Производительность
- Debounce для автоподбора (300ms)
- Lazy loading для страниц (изображений)
- Оптимизация рендеринга больших списков
- Кэширование данных категорий, языков и т.д.

### Безопасность
- Проверка прав доступа на бэкенде
- Валидация данных на бэкенде и фронтенде
- Защита от XSS (санитизация пользовательского ввода)
- Ограничение размера загружаемых файлов

---

## Порядок выполнения этапов

1. **Этап 1: BookDetailModal** → Тестирование → ✅ ЗАВЕРШЕН
2. **Этап 2: BookCreateWizard - Шаг 1** → Тестирование → ✅ ЗАВЕРШЕН
3. **Этап 3: BookCreateWizard - Шаг 2** → Тестирование → ⚠️ ТРЕБУЕТ ДОРАБОТКИ (базовая функциональность работает, но качество нормализации требует улучшения)
4. **Этап 4: BookCreateWizard - Шаг 3** → Тестирование → ✅ ЗАВЕРШЕН
5. **Этап 5: BookCreateWizard - Шаг 4** → Тестирование → ✅ ЗАВЕРШЕН (частично: основные поля реализованы, электронные версии и хэштеги - на следующих этапах)
6. **Этап 6: BookCreateWizard - Шаг 5** → Тестирование → ✅ ЗАВЕРШЕН
7. **Этап 7: BookEditModal** → Тестирование → ✅ ЗАВЕРШЕН
8. **Этап 8: BookTransferModal** → Тестирование → ✅ ЗАВЕРШЕН
9. **Этап 9: BookDeleteConfirm** → Тестирование → ✅ ЗАВЕРШЕН

**Важно:** Каждый этап должен быть полностью завершен и протестирован перед переходом к следующему!

---

