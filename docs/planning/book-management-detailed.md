# Детальный план реализации функционала работы с книгами

**Дата создания:** 2025-01-27  
**Статус:** Детализированный план реализации  
**Основа:** Утвержденный план из `book-management.md`

---

## Технологический стек

### Нормализация изображений
- **Технология:** Dynamsoft Capture Vision SDK (уже используется в `document_processor.py`)
- **Механизм:** 
  - Обнаружение границ документа
  - Перспективное преобразование (four_point_transform)
  - Сохранение с качеством JPEG 90%
- **Использование:** Адаптировать существующий `process_document()` для пакетной обработки

### LLM интеграция
- **API:** OpenAI GPT-4o (ChatGPT-4o)
- **Модель:** `gpt-4o`
- **Формат ответа:** Строго структурированный JSON
- **Входные данные:** 
  - Изображения страниц (base64 или URLs)
  - JSON с категориями из `categories_canonical.json`

---

## Структура JSON для LLM

### Входные данные (категории)
```json
{
  "categories": [
    {
      "id": 1,
      "name": "Азия",
      "subcategories": [
        {"id": 2, "name": "Индия, Пакистан, Тибет, Цейлон (Шри-Ланка)"},
        ...
      ]
    },
    ...
  ]
}
```

### Выходные данные от LLM (структурированный JSON)
```json
{
  "title": "Название книги",
  "subtitle": "Подзаголовок (если есть)",
  "category_id": 1,
  "authors": ["Фамилия Имя", "Фамилия Имя"],
  "publisher_name": "Название издательства",
  "publication_place": "Город",
  "year": 2023,
  "year_approx": "",
  "pages_info": "300 стр., ил.",
  "circulation": 5000,
  "language_name": "Русский",
  "binding_type": "hard",
  "binding_details": "Твердый переплет, красный",
  "format": "regular",
  "condition": "excellent",
  "condition_details": "",
  "price_rub": "1500.00",
  "seller_code": "",
  "isbn": "978-5-123456-78-9",
  "description": "Аннотация книги"
}
```

**Поля, НЕ включаемые в ответ LLM:**
- `owner` - заполняется автоматически на бэкенде
- `library` - выбирается пользователем в форме
- `status` - выбирается пользователем в форме
- `hashtags` - добавляются пользователем в форме
- `created_at`, `updated_at` - системные поля
- `images`, `electronic_versions`, `pages`, `reviews`, `reading_dates` - управляются отдельно

---

## Промпт для LLM

```markdown
Ты - эксперт по анализу книг. Проанализируй предоставленные изображения страниц книги и извлеки всю возможную информацию.

ДОСТУПНЫЕ КАТЕГОРИИ:
{categories_json}

ЗАДАЧА:
1. Определи название книги
2. Определи авторов (если есть)
3. Определи издательство
4. Определи место и год издания
5. Определи ISBN (если есть)
6. Определи тип переплета, формат, состояние
7. Определи язык текста
8. Определи наиболее подходящую категорию из предоставленного списка
9. Извлеки любую другую доступную информацию

ВАЖНО:
- Если информация не найдена на изображениях, оставь поле пустым или null
- Для category_id используй ID из предоставленного списка категорий
- Для binding_type используй только: paper, selfmade, cardboard, hard, fabric, owner, halfleather, composite, leather
- Для format используй только: very_large, encyclopedic, increased, regular, reduced, miniature
- Для condition используй только: ideal, excellent, good, satisfactory, poor
- Для language_name используй полное название языка (например, "Русский", "Английский")
- Авторов может не быть (массив может быть пустым)
- Год издания может быть точным (year) или приблизительным (year_approx, например "197?", "18??")

ВЕРНИ ОТВЕТ СТРОГО В ФОРМАТЕ JSON согласно схеме:
{
  "title": string (обязательно),
  "subtitle": string или null,
  "category_id": integer или null,
  "authors": array of strings или [],
  "publisher_name": string или null,
  "publication_place": string или null,
  "year": integer или null,
  "year_approx": string или null,
  "pages_info": string или null,
  "circulation": integer или null,
  "language_name": string или null,
  "binding_type": string или null,
  "binding_details": string или null,
  "format": string или null,
  "condition": string или null,
  "condition_details": string или null,
  "price_rub": string или null (десятичное число как строка),
  "seller_code": string или null,
  "isbn": string или null,
  "description": string или null
}
```

---

## Этапы реализации

### Этап 1: BookDetailModal (Просмотр книги)

**Цель:** Реализовать модальное окно для просмотра детальной информации о книге

#### Задачи:
1. Создать компонент `BookDetailModal.js`
2. Создать стили `BookDetailModal.css`
3. Интегрировать с главной страницей (открытие по клику на карточку)
4. Реализовать отображение всех полей книги
5. Добавить кнопки действий: "Редактировать", "Передать", "Удалить", "Закрыть"

#### API Endpoints:
- `GET /api/books/{id}/` - получение детальной информации

#### Структура данных:
```javascript
{
  id, title, subtitle, category, authors, publisher, publication_place,
  year, year_approx, pages_info, circulation, language, binding_type,
  binding_details, format, condition, condition_details, price_rub,
  seller_code, isbn, description, status, library, owner, created_at,
  images: [], electronic_versions: [], pages: [], reviews: [], 
  reading_dates: [], hashtags: []
}
```

#### Тестирование:
- [ ] Модальное окно открывается по клику на карточку книги
- [ ] Все поля отображаются корректно
- [ ] Пустые поля обрабатываются правильно (не показываются или показывается "Не указано")
- [ ] Кнопки действий отображаются
- [ ] Кнопка "Закрыть" закрывает модальное окно
- [ ] Модальное окно закрывается по клику вне его области
- [ ] Модальное окно закрывается по нажатию Escape
- [ ] Отображение изображений работает корректно
- [ ] Отображение списка авторов работает корректно
- [ ] Отображение хэштегов работает корректно

---

### Этап 2: BookCreateWizard - Шаг 1 (Загрузка страниц)

**Цель:** Реализовать загрузку изображений страниц книги

#### Задачи:
1. Создать компонент `BookCreateWizard.js` с управлением шагами
2. Создать компонент `UploadPagesStep.js`
3. Создать стили для wizard и шага загрузки
4. Реализовать drag-and-drop зону
5. Реализовать выбор файлов через input
6. Реализовать отображение списка загруженных файлов
7. Реализовать удаление файлов из списка
8. Добавить кнопки "Пропустить" и "Далее"
9. Валидация: только изображения (jpeg, jpg, png, webp)

#### Технические детали:
- Использовать `FileReader` для предпросмотра
- Хранить файлы в состоянии React (File objects)
- Максимальный размер файла: 10MB (настраиваемо)
- Максимальное количество файлов: 50 (настраиваемо)

#### Тестирование:
- [ ] Drag-and-drop работает корректно
- [ ] Выбор файлов через кнопку работает
- [ ] Валидация типов файлов работает (только изображения)
- [ ] Валидация размера файлов работает
- [ ] Валидация количества файлов работает
- [ ] Предпросмотр загруженных изображений работает
- [ ] Удаление файлов из списка работает
- [ ] Кнопка "Пропустить" переходит к шагу 4
- [ ] Кнопка "Далее" переходит к шагу 2 (если есть файлы) или шагу 4 (если нет)
- [ ] Сообщения об ошибках валидации отображаются корректно

---

### Этап 3: BookCreateWizard - Шаг 2 (Нормализация страниц)

**Цель:** Реализовать автоматическую нормализацию загруженных страниц

#### Задачи:
1. Создать компонент `NormalizationStep.js`
2. Создать API endpoint `POST /api/books/normalize-pages/`
3. Адаптировать `process_document()` для пакетной обработки
4. Реализовать прогресс-бар нормализации
5. Реализовать отображение миниатюр до и после нормализации
6. Добавить кнопки "Пропустить нормализацию" и "Далее"
7. Сохранение нормализованных изображений во временное хранилище

#### API Endpoint:
```python
POST /api/books/normalize-pages/
Content-Type: multipart/form-data

Body:
- files: List[File] - загруженные изображения

Response:
{
  "normalized_images": [
    {
      "id": "temp_123",
      "original_filename": "page1.jpg",
      "normalized_url": "/media/temp/normalized_123.jpg",
      "width": 1920,
      "height": 2560
    },
    ...
  ],
  "total": 5,
  "processed": 5
}
```

#### Технические детали:
- Использовать существующий `document_processor.process_document()`
- Обработка файлов последовательно или параллельно (на выбор)
- Сохранение во временную директорию `media/temp/normalized/`
- Очистка временных файлов через 24 часа (cron job или celery task)

#### Тестирование:
- [ ] Нормализация работает для одного файла
- [ ] Нормализация работает для нескольких файлов
- [ ] Прогресс-бар обновляется корректно
- [ ] Миниатюры до и после отображаются корректно
- [ ] Ошибки обработки обрабатываются корректно
- [ ] Кнопка "Пропустить нормализацию" работает
- [ ] Кнопка "Далее" активна после завершения нормализации
- [ ] Временные файлы создаются корректно
- [ ] Нормализованные изображения имеют правильные размеры

---

### Этап 4: BookCreateWizard - Шаг 3 (Автозаполнение через LLM)

**Цель:** Реализовать автоматическое заполнение данных книги через OpenAI GPT-4o

#### Задачи:
1. Создать компонент `AutoFillStep.js`
2. Создать сервис `llm_service.py` для работы с OpenAI API
3. Создать API endpoint `POST /api/books/auto-fill/`
4. Реализовать загрузку категорий из `categories_canonical.json`
5. Реализовать отправку изображений и категорий в OpenAI API
6. Реализовать парсинг ответа от LLM
7. Реализовать валидацию ответа от LLM
8. Реализовать предзаполнение формы данными от LLM
9. Добавить кнопки "Заполнить автоматически" и "Пропустить автозаполнение"

#### API Endpoint:
```python
POST /api/books/auto-fill/
Content-Type: application/json

Body:
{
  "normalized_image_ids": ["temp_123", "temp_124", ...],
  "normalized_image_urls": ["/media/temp/normalized_123.jpg", ...]
}

Response:
{
  "success": true,
  "data": {
    "title": "...",
    "subtitle": "...",
    ...
  },
  "confidence": 0.85  // Уровень уверенности LLM (опционально)
}
```

#### Сервис LLM (`llm_service.py`):
```python
def auto_fill_book_data(image_urls, categories_json):
    """
    Отправляет изображения и категории в OpenAI GPT-4o
    и получает структурированные данные о книге
    """
    # 1. Подготовка промпта
    # 2. Отправка запроса в OpenAI API
    # 3. Парсинг ответа
    # 4. Валидация данных
    # 5. Возврат структурированных данных
```

#### Технические детали:
- Использовать `openai` Python библиотеку
- Модель: `gpt-4o`
- Формат ответа: JSON mode (если доступно) или strict JSON parsing
- Таймаут запроса: 60 секунд
- Обработка ошибок: retry с exponential backoff (до 3 попыток)
- Логирование всех запросов и ответов

#### Тестирование:
- [ ] Отправка изображений в OpenAI API работает
- [ ] Промпт формируется корректно
- [ ] Категории передаются корректно
- [ ] Ответ от LLM парсится корректно
- [ ] Валидация ответа от LLM работает
- [ ] Обработка ошибок API работает (network, timeout, rate limit)
- [ ] Retry механизм работает
- [ ] Предзаполнение формы данными от LLM работает
- [ ] Кнопка "Пропустить автозаполнение" работает
- [ ] Если страницы не загружены, шаг 3 пропускается автоматически
- [ ] Индикатор загрузки отображается корректно

---

### Этап 5: BookCreateWizard - Шаг 4 (Заполнение данных)

**Цель:** Реализовать форму для заполнения/редактирования данных книги

#### Задачи:
1. Создать компонент `BookFormStep.js` с полной формой
2. Реализовать все поля формы с соответствующими типами input
3. Реализовать автоподбор авторов (`GET /api/authors/?search=...`)
4. Реализовать автоподбор издательств (`GET /api/publishers/?search=...`)
5. Реализовать создание новых авторов (inline модальное окно)
6. Реализовать создание новых издательств (inline модальное окно)
7. Реализовать выбор категории из дерева категорий
8. Реализовать выбор языка из списка языков
9. Реализовать выбор библиотеки из библиотек пользователя
10. Реализовать выбор хэштегов (с созданием новых)
11. Реализовать валидацию формы (только title обязателен)
12. Добавить кнопки "Назад" и "Далее"

#### Компоненты:
- `BookFormStep.js` - основная форма
- `AuthorAutocomplete.js` - автоподбор авторов
- `PublisherAutocomplete.js` - автоподбор издательств
- `CategorySelector.js` - выбор категории
- `LanguageSelector.js` - выбор языка
- `LibrarySelector.js` - выбор библиотеки
- `HashtagSelector.js` - выбор хэштегов
- `CreateAuthorModal.js` - создание нового автора
- `CreatePublisherModal.js` - создание нового издательства

#### Валидация:
- Название (title): обязательное, минимум 1 символ, максимум 500 символов
- Год издания (year): если указан, должен быть от 0 до 2100
- Тираж (circulation): если указан, должен быть >= 1
- Цена (price_rub): если указана, должна быть >= 0
- Авторы: максимум 3 автора
- Хэштеги: максимум 20 хэштегов

#### Тестирование:
- [ ] Все поля формы отображаются корректно
- [ ] Предзаполнение данными от LLM работает
- [ ] Автоподбор авторов работает (debounce 300ms)
- [ ] Автоподбор издательств работает (debounce 300ms)
- [ ] Создание нового автора работает
- [ ] Создание нового издательства работает
- [ ] Выбор категории работает
- [ ] Выбор языка работает
- [ ] Выбор библиотеки работает
- [ ] Выбор хэштегов работает
- [ ] Валидация названия работает (обязательное поле)
- [ ] Валидация других полей работает (если заполнены)
- [ ] Кнопка "Назад" работает (переход к предыдущему шагу)
- [ ] Кнопка "Далее" активна только если заполнено название
- [ ] Сообщения об ошибках валидации отображаются корректно
- [ ] Можно создать книгу только с названием (без других полей)

---

### Этап 6: BookCreateWizard - Шаг 5 (Подтверждение и создание)

**Цель:** Реализовать финальный просмотр и создание книги

#### Задачи:
1. Создать компонент `ConfirmationStep.js`
2. Реализовать отображение сводки всех данных книги
3. Реализовать отображение миниатюр страниц (если были загружены)
4. Реализовать валидацию перед созданием (проверка названия)
5. Реализовать отправку запроса на создание книги
6. Реализовать обработку успеха/ошибок
7. Добавить кнопки "Назад", "Создать книгу", "Отмена"

#### API Endpoint:
```python
POST /api/books/
Content-Type: multipart/form-data или application/json

Body:
{
  // Все поля книги + normalized_image_ids
}
```

#### Технические детали:
- При создании книги переместить нормализованные изображения из temp в постоянное хранилище
- Создать записи BookPage для каждой нормализованной страницы
- Обработать создание авторов/издательств (если были созданы новые)
- После успешного создания закрыть wizard и обновить список книг

#### Тестирование:
- [ ] Сводка всех данных отображается корректно
- [ ] Миниатюры страниц отображаются (если были загружены)
- [ ] Валидация названия перед созданием работает
- [ ] Создание книги работает (все поля)
- [ ] Создание книги работает (только название)
- [ ] Создание книги с авторами работает
- [ ] Создание книги с страницами работает
- [ ] Обработка ошибок создания работает
- [ ] После успешного создания wizard закрывается
- [ ] После успешного создания список книг обновляется
- [ ] Кнопка "Назад" работает
- [ ] Кнопка "Отмена" закрывает wizard

---

### Этап 7: BookEditModal (Редактирование книги)

**Цель:** Реализовать модальное окно для редактирования существующей книги

#### Задачи:
1. Создать компонент `BookEditModal.js`
2. Переиспользовать форму из `BookFormStep.js` (или создать общий компонент)
3. Реализовать загрузку данных книги при открытии
4. Реализовать предзаполнение формы существующими данными
5. Реализовать управление изображениями (добавление/удаление)
6. Реализовать управление электронными версиями (добавление/удаление)
7. Реализовать управление страницами (просмотр/удаление)
8. Реализовать сохранение изменений
9. Добавить кнопки "Сохранить изменения" и "Отмена"

#### API Endpoints:
- `GET /api/books/{id}/` - получение данных для редактирования
- `PUT /api/books/{id}/` - обновление книги
- `POST /api/books/{id}/images/` - добавление изображения
- `DELETE /api/books/{id}/images/{image_id}/` - удаление изображения
- `POST /api/books/{id}/electronic_versions/` - добавление электронной версии
- `DELETE /api/books/{id}/electronic_versions/{version_id}/` - удаление версии
- `DELETE /api/books/{id}/pages/{page_id}/` - удаление страницы

#### Тестирование:
- [ ] Модальное окно открывается из BookDetailModal
- [ ] Данные книги загружаются корректно
- [ ] Форма предзаполняется существующими данными
- [ ] Редактирование всех полей работает
- [ ] Валидация работает
- [ ] Сохранение изменений работает
- [ ] Добавление изображений работает
- [ ] Удаление изображений работает
- [ ] Добавление электронных версий работает
- [ ] Удаление электронных версий работает
- [ ] Удаление страниц работает
- [ ] После сохранения данные в BookDetailModal обновляются
- [ ] Кнопка "Отмена" закрывает модальное окно
- [ ] Обработка ошибок сохранения работает

---

### Этап 8: BookTransferModal (Передача книги)

**Цель:** Реализовать модальное окно для передачи книги в другую библиотеку

#### Задачи:
1. Создать компонент `BookTransferModal.js`
2. Реализовать загрузку списка доступных библиотек
3. Реализовать выбор целевой библиотеки
4. Реализовать отправку запроса на передачу
5. Добавить кнопки "Передать" и "Отмена"

#### API Endpoint:
```python
POST /api/books/{id}/transfer/
Content-Type: application/json

Body:
{
  "target_library_id": 5
}

Response:
{
  "success": true,
  "message": "Книга успешно передана",
  "book": {...}
}
```

#### Тестирование:
- [ ] Модальное окно открывается из BookDetailModal
- [ ] Список доступных библиотек загружается
- [ ] Выбор библиотеки работает
- [ ] Передача книги работает
- [ ] После передачи данные в BookDetailModal обновляются
- [ ] Кнопка "Отмена" закрывает модальное окно
- [ ] Обработка ошибок передачи работает

---

### Этап 9: BookDeleteConfirm (Подтверждение удаления)

**Цель:** Реализовать диалог подтверждения удаления книги

#### Задачи:
1. Создать компонент `BookDeleteConfirm.js`
2. Реализовать отображение информации о книге
3. Реализовать отправку запроса на удаление
4. Добавить кнопки "Удалить" и "Отмена"

#### API Endpoint:
```python
DELETE /api/books/{id}/
```

#### Тестирование:
- [ ] Диалог открывается из BookDetailModal
- [ ] Информация о книге отображается корректно
- [ ] Удаление книги работает
- [ ] После удаления все модальные окна закрываются
- [ ] После удаления список книг обновляется
- [ ] Кнопка "Отмена" закрывает диалог
- [ ] Обработка ошибок удаления работает

---

## Общие требования ко всем этапам

### UI/UX
- Все модальные окна должны быть responsive
- Анимации открытия/закрытия модальных окон
- Индикаторы загрузки для всех асинхронных операций
- Сообщения об ошибках должны быть понятными
- Успешные операции должны показывать уведомления

### Обработка ошибок
- Сетевые ошибки (network, timeout)
- Ошибки валидации (400)
- Ошибки авторизации (401, 403)
- Ошибки сервера (500)
- Специфичные ошибки API

### Производительность
- Debounce для автоподбора (300ms)
- Lazy loading для изображений
- Оптимизация рендеринга больших списков
- Кэширование данных категорий, языков и т.д.

### Безопасность
- Проверка прав доступа на бэкенде
- Валидация данных на бэкенде и фронтенде
- Защита от XSS (санитизация пользовательского ввода)
- Ограничение размера загружаемых файлов

---

## Порядок выполнения этапов

1. **Этап 1** → Тестирование → ✅
2. **Этап 2** → Тестирование → ✅
3. **Этап 3** → Тестирование → ✅
4. **Этап 4** → Тестирование → ✅
5. **Этап 5** → Тестирование → ✅
6. **Этап 6** → Тестирование → ✅
7. **Этап 7** → Тестирование → ✅
8. **Этап 8** → Тестирование → ✅
9. **Этап 9** → Тестирование → ✅

**Важно:** Каждый этап должен быть полностью завершен и протестирован перед переходом к следующему!

---

## Чек-лист готовности к реализации

- [ ] План детализирован и утвержден
- [ ] Все технологии выбраны и изучены
- [ ] API endpoints определены
- [ ] Структура данных определена
- [ ] Промпт для LLM готов
- [ ] Тестовые данные подготовлены
- [ ] Инфраструктура для тестирования готова

---

**Следующий шаг:** Начать реализацию с Этапа 1 (BookDetailModal)

