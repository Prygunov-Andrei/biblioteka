# Планирование функционала работы с книгами

**Дата создания:** 2025-01-27  
**Дата утверждения:** 2025-01-27  
**Статус:** ✅ Утверждено - готово к детализации

---

## Обзор

Реализация полного функционала для работы с книгами:
- Создание книги (с автоматическим заполнением через LLM)
- Просмотр книги
- Редактирование книги
- Передача книги в другую библиотеку
- Удаление книги

---

## Структура модальных окон

### 1. BookDetailModal (Просмотр книги)

**Назначение:** Отображение всей информации о книге в режиме просмотра (read-only)

**Поля книги:**
- Основная информация:
  - Название (title)
  - Подзаголовок (subtitle)
  - Категория (category)
  - Авторы (authors) - список
  - Издательство (publisher)
  - Место издания (publication_place)
  - Год издания (year)
  - Приблизительный год (year_approx)
  
- Физические характеристики:
  - Тираж (circulation)
  - Язык текста (language)
  - Информация о страницах (pages_info)
  - Тип переплета (binding_type)
  - Детали переплета (binding_details)
  - Формат (format)
  - Состояние (condition)
  - Детали состояния (condition_details)
  
- Коммерческая информация:
  - Цена в рублях (price_rub)
  - Код продавца (seller_code)
  - ISBN (isbn)
  
- Дополнительная информация:
  - Описание (description)
  - Статус чтения (status)
  - Библиотека (library)
  - Владелец (owner)
  
- Связанные данные:
  - Изображения (images)
  - Электронные версии (electronic_versions)
  - Страницы (pages)
  - Отзывы (reviews)
  - Даты прочтения (reading_dates)
  - Хэштеги (hashtags)

**Кнопки:**
- "Редактировать" → открывает BookEditModal
- "Передать" → открывает BookTransferModal
- "Удалить" → открывает BookDeleteConfirm
- "Закрыть" → закрывает модальное окно

**Как открывается:**
- Клик по карточке книги в списке

---

### 2. BookCreateWizard (Создание книги - многошаговый процесс)

**Назначение:** Пошаговое создание книги с опциональным автоматическим заполнением

**Важно:** 
- Загрузка страниц и автозаполнение через LLM - **опциональны**
- Пользователь может пропустить эти шаги и заполнить все вручную
- Обязательное поле - только **название книги**
- Автор может отсутствовать

#### Шаг 1: Загрузка страниц (ОПЦИОНАЛЬНО)
**Поля:** Нет полей книги

**Элементы:**
- Drag-and-drop зона для загрузки изображений страниц
- Или кнопка "Выбрать файлы"
- Список загруженных файлов с возможностью удаления
- Кнопка "Пропустить" (переход к шагу 4 - заполнение вручную)
- Кнопка "Далее" (активна всегда, если загружены страницы → переход к шагу 2, если нет → переход к шагу 4)

**Действия:**
- Загрузка файлов страниц (опционально)
- Валидация: только изображения
- Если загружены страницы → переход к шагу 2 (нормализация)
- Если не загружены → переход к шагу 4 (заполнение вручную)

#### Шаг 2: Нормализация страниц (ОПЦИОНАЛЬНО, только если загружены страницы)
**Поля:** Нет полей книги

**Элементы:**
- Прогресс-бар нормализации
- Миниатюры страниц (до и после нормализации)
- Кнопка "Пропустить нормализацию" (переход к шагу 3)
- Кнопка "Далее" (активна после завершения нормализации → переход к шагу 3)

**Действия:**
- Автоматическая нормализация (уменьшение размера, обрезка, выравнивание)
- Показ прогресса
- После завершения → переход к шагу 3 (автозаполнение)
- Можно пропустить → переход к шагу 3 без нормализации

#### Шаг 3: Автоматическое заполнение (ОПЦИОНАЛЬНО)
**Поля:** Нет полей книги (пока)

**Элементы:**
- Кнопка "Заполнить автоматически" (активна только если есть страницы)
- Индикатор загрузки при запросе к LLM
- После получения данных → предзаполнение всех полей
- Кнопка "Пропустить автозаполнение" (переход к шагу 4 - заполнение вручную)
- Кнопка "Далее" (активна после получения данных от LLM или если пропущено → переход к шагу 4)

**Действия:**
- Отправка изображений + JSON категорий в LLM API (если есть страницы)
- Получение предсказанных данных
- Автоматическое заполнение формы → переход к шагу 4
- Можно пропустить → переход к шагу 4 с пустой формой

**Примечание:** Если страницы не загружены, шаг 3 пропускается автоматически

#### Шаг 4: Заполнение данных (обязательный шаг)
**Поля книги (все поля, все опциональны кроме названия):**

**Обязательные поля:**
- Название (title) ✓ **ОБЯЗАТЕЛЬНО**

**Опциональные поля:**

- Основная информация:
  - Подзаголовок (subtitle) ✓
  - Категория (category) - выбор из списка ✓
  - Авторы (authors) - поиск и выбор из базы, создание новых ✓ **ОПЦИОНАЛЬНО - книги может не быть автора**
  - Издательство (publisher) - поиск и выбор из базы, создание новых ✓
  - Место издания (publication_place) ✓
  - Год издания (year) ✓
  - Приблизительный год (year_approx) ✓
  
- Физические характеристики:
  - Тираж (circulation) ✓
  - Язык текста (language) - выбор из списка ✓
  - Информация о страницах (pages_info) ✓
  - Тип переплета (binding_type) - выбор из списка ✓
  - Детали переплета (binding_details) ✓
  - Формат (format) - выбор из списка ✓
  - Состояние (condition) - выбор из списка ✓
  - Детали состояния (condition_details) ✓
  
- Коммерческая информация:
  - Цена в рублях (price_rub) ✓
  - Код продавца (seller_code) ✓
  - ISBN (isbn) ✓
  
- Дополнительная информация:
  - Описание (description) - текстовое поле ✓
  - Статус чтения (status) - выбор из списка ✓
  - Библиотека (library) - выбор из библиотек пользователя ✓
  
- Связанные данные:
  - Хэштеги (hashtags) - выбор из существующих, создание новых ✓

**Элементы:**
- Все поля формы
- Если были данные от LLM → предзаполнение всех полей
- Если не было LLM → форма пустая (кроме загруженных страниц, если были)
- Автоподбор авторов/издательств при вводе (выпадающий список)
- Кнопка "Создать нового автора" (если нет совпадений)
- Кнопка "Создать новое издательство" (если нет совпадений)
- Кнопка "Назад" (к шагу 3, если был, иначе к шагу 1)
- Кнопка "Далее" (к шагу 5, активна если заполнено хотя бы название)

**Действия:**
- Редактирование всех полей
- Валидация: только название обязательно
- Автоподбор из базы данных
- Создание новых авторов/издательств при необходимости
- Можно создать книгу без автора, без категории, без других полей (только название)

#### Шаг 5: Подтверждение и создание
**Поля:** Нет полей (только просмотр)

**Элементы:**
- Сводка всех данных книги (read-only)
- Миниатюры страниц (если были загружены)
- Отображение заполненных полей
- Предупреждение о пустых обязательных полях (если название не заполнено)
- Кнопка "Назад" (к шагу 4)
- Кнопка "Создать книгу" (активна если заполнено название)
- Кнопка "Отмена" (закрыть wizard)

**Действия:**
- Финальный просмотр всех данных
- Валидация: проверка что название заполнено
- Отправка запроса на создание книги
- Обработка успеха/ошибок
- После успешного создания → закрытие wizard и обновление списка книг

**Примечание:** 
- Книга может быть создана только с названием
- Все остальные поля опциональны
- Страницы могут отсутствовать

---

### 3. BookEditModal (Редактирование книги)

**Назначение:** Редактирование существующей книги

**Поля книги (все поля, кроме):**
- Нельзя редактировать:
  - Владелец (owner) - только просмотр
  - Создано (created_at) - только просмотр
  
**Все остальные поля как в BookCreateWizard Шаг 4 (все опциональны кроме названия):**
- Основная информация: 
  - title ✓ **ОБЯЗАТЕЛЬНО**
  - subtitle, category, authors (опционально, может не быть), publisher, publication_place, year, year_approx ✓
- Физические характеристики: circulation, language, pages_info, binding_type, binding_details, format, condition, condition_details ✓
- Коммерческая информация: price_rub, seller_code, isbn ✓
- Дополнительная информация: description, status, library ✓
- Связанные данные: hashtags ✓

**Дополнительно:**
- Управление изображениями (добавление/удаление)
- Управление электронными версиями (добавление/удаление)
- Управление страницами (просмотр/удаление)

**Кнопки:**
- "Сохранить изменения"
- "Отмена" (закрыть модальное окно)

**Как открывается:**
- Из BookDetailModal → кнопка "Редактировать"

**Действия:**
- Предзаполнение формы существующими данными
- Редактирование полей
- Валидация
- Сохранение изменений через API
- После успешного сохранения → закрытие и обновление данных

---

### 4. BookTransferModal (Передача книги)

**Назначение:** Передача книги в другую библиотеку

**Поля:**
- Текущая библиотека (library) - только просмотр
- Выбор целевой библиотеки (target_library) - выбор из списка доступных библиотек

**Кнопки:**
- "Передать"
- "Отмена" (закрыть модальное окно)

**Как открывается:**
- Из BookDetailModal → кнопка "Передать"

**Действия:**
- Выбор библиотеки из списка
- Подтверждение передачи
- Отправка запроса на передачу
- После успешной передачи → закрытие и обновление данных

---

### 5. BookDeleteConfirm (Подтверждение удаления)

**Назначение:** Подтверждение удаления книги

**Поля:** Нет

**Элементы:**
- Текст предупреждения: "Вы уверены, что хотите удалить книгу 'Название книги'?"
- Информация о книге (название, автор)

**Кнопки:**
- "Удалить" (красная кнопка)
- "Отмена" (закрыть диалог)

**Как открывается:**
- Из BookDetailModal → кнопка "Удалить"

**Действия:**
- Подтверждение удаления
- Отправка запроса на удаление
- После успешного удаления → закрытие модального окна и обновление списка

---

## Навигация между модальными окнами

### Создание книги (с загрузкой страниц и автозаполнением)
```
Главная страница
  → Кнопка "Добавить книгу" в шапке
    → BookCreateWizard (Шаг 1: Загрузка страниц)
      → Загружены страницы → Шаг 2 (Нормализация)
        → Шаг 3 (Автозаполнение через LLM)
          → Шаг 4 (Заполнение данных - предзаполнено)
            → Шаг 5 (Подтверждение)
              → После создания → закрытие, обновление списка
```

### Создание книги (без загрузки страниц, заполнение вручную)
```
Главная страница
  → Кнопка "Добавить книгу" в шапке
    → BookCreateWizard (Шаг 1: Загрузка страниц)
      → Кнопка "Пропустить" или "Далее" (без страниц)
        → Шаг 4 (Заполнение данных - форма пустая)
          → Шаг 5 (Подтверждение)
            → После создания → закрытие, обновление списка
```

### Создание книги (загрузка страниц, но без автозаполнения)
```
Главная страница
  → Кнопка "Добавить книгу" в шапке
    → BookCreateWizard (Шаг 1: Загрузка страниц)
      → Загружены страницы → Шаг 2 (Нормализация)
        → Шаг 3 (Автозаполнение)
          → Кнопка "Пропустить автозаполнение"
            → Шаг 4 (Заполнение данных - форма пустая, но страницы готовы)
              → Шаг 5 (Подтверждение)
                → После создания → закрытие, обновление списка
```

### Просмотр и редактирование
```
Главная страница
  → Клик по карточке книги
    → BookDetailModal
      → Кнопка "Редактировать"
        → BookEditModal
          → После сохранения → закрытие, возврат к BookDetailModal (обновление данных)
      → Кнопка "Передать"
        → BookTransferModal
          → После передачи → закрытие, возврат к BookDetailModal (обновление данных)
      → Кнопка "Удалить"
        → BookDeleteConfirm
          → После удаления → закрытие всех модальных окон, обновление списка
```

---

## Кнопки на главной странице

- **"Добавить книгу"** (в шапке, справа от поиска)
  - Открывает BookCreateWizard (Шаг 1)

---

## Кнопки на карточке книги (в списке)

- **Клик по карточке**
  - Открывает BookDetailModal

---

## Технические детали (упрощенно)

### API Endpoints (используемые)
- `GET /api/books/{id}/` - получение детальной информации
- `POST /api/books/` - создание книги
- `PUT /api/books/{id}/` - обновление книги
- `DELETE /api/books/{id}/` - удаление книги
- `POST /api/books/{id}/transfer/` - передача книги
- `POST /api/books/normalize-pages/` - нормализация страниц
- `POST /api/books/auto-fill/` - автозаполнение через LLM
- `GET /api/authors/?search=...` - поиск авторов
- `GET /api/publishers/?search=...` - поиск издательств
- `GET /api/categories/tree/` - получение категорий

### Состояние (React)
- Модальные окна управляются через состояние
- BookCreateWizard хранит данные всех шагов
- Автоподбор использует debounce для поиска

---

## Следующие шаги

После проверки и утверждения этого плана:
1. Детализация каждого шага BookCreateWizard
2. Детализация валидации полей
3. Детализация интеграции с LLM API
4. Детализация процесса нормализации
5. Детализация UI/UX каждого модального окна
6. Детализация обработки ошибок

---

## Важные особенности реализации

### Обязательность полей
- **Обязательное поле:** только `title` (название книги)
- **Все остальные поля опциональны**, включая:
  - Авторы (книга может быть без автора)
  - Категория
  - Издательство
  - Год издания
  - Все остальные поля

### Гибкость процесса создания
- Пользователь может создать книгу:
  1. С загрузкой страниц + автозаполнением через LLM
  2. С загрузкой страниц, но без автозаполнения (заполнение вручную)
  3. Без загрузки страниц, заполнение полностью вручную
  4. Только с названием (минимум данных)

### Валидация
- На фронтенде: проверка что название заполнено
- На бэкенде: проверка что название заполнено
- Все остальные поля валидируются только если заполнены

---

## Статус утверждения

✅ **План утвержден** (2025-01-27)

**Ответы на вопросы:**
1. ✅ Все поля учтены
2. ✅ Распределение полей по модальным окнам правильное
3. ✅ Последовательность шагов в BookCreateWizard подходит
4. ✅ Дополнительных кнопок или действий не требуется
5. ✅ Требование "только название обязательно" понято правильно

**Следующий шаг:** Детализация плана с подробным описанием каждого шага, UI/UX, валидации и обработки ошибок.

