# Настройка базы данных для продакшн

## Автоматическая установка (рекомендуется)

Для продакшн используется стандартный процесс миграций Django. Все таблицы создаются автоматически:

```bash
# 1. Создать базу данных (PostgreSQL)
createdb biblioteka

# 2. Применить все миграции
cd backend
python manage.py migrate

# 3. Загрузить начальные данные (категории)
python manage.py sync_categories

# 4. Создать суперпользователя
python manage.py createsuperuser
```

## Проверка состояния миграций

Проверить, какие миграции применены:

```bash
python manage.py showmigrations
```

Все миграции должны быть отмечены как `[X]` (применены).

## Если миграции не применяются

### Проблема: Миграция помечена как примененная, но таблицы не существуют

Это происходит, если состояние миграций рассинхронизировано с реальной БД.

**Решение:**

1. Если таблицы отсутствуют, но миграция помечена как примененная:
```bash
# Откатить миграцию (пометить как непримененную)
python manage.py migrate books 0004_alter_book_binding_details_and_more --fake

# Применить миграцию заново
python manage.py migrate books 0005_add_user_system
```

3. Если миграция не может быть применена из-за конфликтов (например, колонки уже существуют):
   - Откатите миграцию и примените заново (см. пункт выше)
   - Или пометьте миграцию как примененную: `python manage.py migrate books 0005_add_user_system --fake`

### Проблема: Ошибка "relation does not exist"

Если при запуске приложения появляются ошибки типа `relation "books_hashtag" does not exist`:

1. Проверьте состояние миграций:
```bash
python manage.py showmigrations books
```

2. Убедитесь, что все миграции применены:
```bash
python manage.py migrate
```

3. Если миграции применены, но таблиц нет - см. раздел выше.

## Важные таблицы из миграции 0005_add_user_system

- `books_userprofile` - профили пользователей
- `books_library` - библиотеки пользователей
- `books_hashtag` - хэштеги
- `books_bookhashtag` - связь книг и хэштегов
- `books_bookreview` - отзывы на книги

## Рекомендации для продакшн

1. **Всегда делайте бэкап БД перед применением миграций**
2. **Проверяйте миграции на тестовой среде перед продакшн**
3. **Используйте `--fake` только в крайних случаях**
4. **Документируйте все ручные изменения в БД**

## Автоматическая проверка в CI/CD

Добавьте проверку состояния БД в pipeline:

```bash
# В вашем CI/CD скрипте
python manage.py migrate --check  # Проверяет, что все миграции применены
```

