# Настройка OpenAI API для автозаполнения книг

## Получение API ключа

1. **Зарегистрируйтесь или войдите на OpenAI:**
   - Перейдите на https://platform.openai.com/
   - Войдите в свой аккаунт или создайте новый

2. **Создайте API ключ:**
   - Перейдите в раздел "API keys": https://platform.openai.com/api-keys
   - Нажмите "Create new secret key"
   - Дайте ключу имя (например, "Biblioteka Development")
   - **ВАЖНО:** Скопируйте ключ сразу - он показывается только один раз!
   - Ключ выглядит как: `sk-proj-...` (начинается с `sk-`)

3. **Проверьте баланс:**
   - Убедитесь, что у вас есть кредиты на счету
   - Перейдите в "Billing": https://platform.openai.com/account/billing
   - Добавьте способ оплаты, если нужно

## Установка ключа в .env файл (рекомендуется)

Проект использует `.env` файл для хранения переменных окружения. Это самый удобный способ для разработки.

### Шаг 1: Создайте файл .env

Файл `.env` должен находиться в корне проекта:
```
/Users/andrei_prygunov/Dev/biblioteka/.env
```

Если файл еще не создан, скопируйте пример:
```bash
cd /Users/andrei_prygunov/Dev/biblioteka
cp .env.example .env
```

### Шаг 2: Добавьте ваш API ключ

Откройте файл `.env` и замените значение:
```bash
nano .env
```

Или через редактор:
```
OPENAI_API_KEY=sk-proj-ваш-реальный-ключ-здесь
```

**Важно:** 
- Не используйте кавычки вокруг значения
- Не добавляйте пробелы вокруг знака `=`
- Файл `.env` уже добавлен в `.gitignore` и не будет закоммичен

### Шаг 3: Установите зависимости

Убедитесь, что установлен `python-dotenv`:
```bash
cd backend
pip install -r requirements.txt
```

### Шаг 4: Перезапустите Django сервер

После изменения `.env` перезапустите сервер:
```bash
python3 manage.py runserver
```

## Альтернативные способы (если нужно)

### Вариант 1: Временная установка через export

**macOS/Linux:**
```bash
export OPENAI_API_KEY="sk-proj-ваш-ключ-здесь"
```

**Windows (PowerShell):**
```powershell
$env:OPENAI_API_KEY="sk-proj-ваш-ключ-здесь"
```

### Вариант 2: Постоянная установка в системе

**macOS/Linux:**

1. Откройте файл `~/.zshrc`:
   ```bash
   nano ~/.zshrc
   ```

2. Добавьте в конец:
   ```bash
   export OPENAI_API_KEY="sk-proj-ваш-ключ-здесь"
   ```

3. Примените:
   ```bash
   source ~/.zshrc
   ```

## Проверка установки

### Проверка в Django (рекомендуется):

```bash
cd backend
python3 manage.py shell
```

В shell:
```python
import os
key = os.environ.get('OPENAI_API_KEY')
if key:
    print(f"✓ Ключ установлен: {key[:15]}...")
else:
    print("✗ Ключ не найден. Проверьте файл .env")
```

### Проверка файла .env:

```bash
cd /Users/andrei_prygunov/Dev/biblioteka
cat .env | grep OPENAI_API_KEY
```

Должна быть строка вида:
```
OPENAI_API_KEY=sk-proj-...
```

## Безопасность

⚠️ **ВАЖНО:**
- **НИКОГДА** не коммитьте API ключ в Git
- Добавьте `.env` в `.gitignore`
- Не публикуйте ключ в открытых репозиториях
- Если ключ был скомпрометирован, немедленно удалите его на сайте OpenAI и создайте новый

## Стоимость использования

- Модель `gpt-4o` стоит примерно $2.50 за 1M входных токенов и $10 за 1M выходных токенов
- Один запрос с несколькими изображениями может стоить от $0.01 до $0.10 в зависимости от размера изображений
- Рекомендуется установить лимиты расходов в настройках OpenAI

## Решение проблем

### Ошибка 403: "Country, region, or territory not supported"

Если вы получаете ошибку `403 Forbidden` с сообщением `unsupported_country_region_territory`, это означает, что OpenAI API недоступен в вашем регионе.

**Решения:**

1. **Использовать VPN** с сервером в поддерживаемой стране (США, Канада, страны ЕС и др.)
2. **Использовать прокси-сервер** для запросов к OpenAI API
3. **Использовать альтернативный API** (например, через прокси-сервис)
4. **Обратиться в поддержку OpenAI** для получения доступа

**Временное решение для разработки:**
Можно добавить обработку этой ошибки и показывать пользователю понятное сообщение о необходимости VPN.

## Тестирование

После установки ключа перезапустите Django сервер и попробуйте автозаполнение в мастере создания книги.

